# SPDX-FileCopyrightText: The RamenDR authors
# SPDX-License-Identifier: Apache-2.0

---
# yamllint disable rule:line-length
name: E2E

on:  # yamllint disable-line rule:truthy
  pull_request:
    types: [opened, synchronize, reopened]

env:
  NAME_PREFIX: "rdr-"

jobs:
  e2e-rdr:
    runs-on: [self-hosted, e2e-rdr]
    if: github.repository == 'RamenDR/ramen' && contains(fromJson('["nirs", "ShyamsundarR", "BenamarMk", "raghavendra-talur", "rakeshgm", "ELENAGER", "netzzer", "kseegerrh"]'), github.actor)

    steps:
    - name: Checkout Repo
      uses: actions/checkout@v3

    - name: Build ramen-operator container
      run: make docker-build

    - name: Create virtual environment
      run: make venv

    - name: Delete clusters
      if: ${{ always() }}
      working-directory: test
      run: |
        source ../venv
        drenv delete --name-prefix ${{ env.NAME_PREFIX }} envs/regional-dr.yaml

    - name: Start clusters
      working-directory: test
      run: |
        source ../venv
        drenv start --name-prefix ${{ env.NAME_PREFIX }} envs/regional-dr.yaml
        cp ~/.config/drenv/${{ env.NAME_PREFIX }}rdr/config.yaml ../e2e/config.yaml

    - name: Deploy ramen
      run: |
        source venv
        ramenctl deploy --name-prefix ${{ env.NAME_PREFIX }} test/envs/regional-dr.yaml
        ramenctl config --name-prefix ${{ env.NAME_PREFIX }} test/envs/regional-dr.yaml

    - name: Run e2e tests
      run: make e2e-rdr

    - name: Delete clusters
      if: ${{ always() }}
      working-directory: test
      run: |
        source ../venv
        drenv delete --name-prefix ${{ env.NAME_PREFIX }} envs/regional-dr.yaml
