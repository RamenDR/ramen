#!/usr/bin/env python3

# SPDX-FileCopyrightText: The RamenDR authors
# SPDX-License-Identifier: Apache-2.0

import os
import sys
import time

from drenv import commands
from drenv import subctl


def wait_for_cluster(cluster, timeout=180):
    delay = 1
    deadline = time.monotonic() + timeout

    print("Waiting until subctl status is ok")

    while True:
        print("Checking subctl status...")
        try:
            status = subctl.show("all", context=cluster)
        except commands.Error as e:
            print(f"subctl failed with exitcode {e.exitcode}")
        else:
            print(status)
            break

        if time.monotonic() > deadline:
            raise RuntimeError("Timeout waiting for subctl status")

        print(f"Retrying in {delay} seconds...")
        time.sleep(delay)
        delay = min(delay * 2, 16)


if len(sys.argv) != 4:
    print(f"Usage: {sys.argv[0]} broker cluster1 cluster2")
    sys.exit(1)

os.chdir(os.path.dirname(__file__))
broker = sys.argv[1]
clusters = sys.argv[2:]

wait_for_cluster(broker)

for cluster in clusters:
    wait_for_cluster(cluster)

test(cluster)
