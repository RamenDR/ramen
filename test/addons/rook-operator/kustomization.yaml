# SPDX-FileCopyrightText: The RamenDR authors
# SPDX-License-Identifier: Apache-2.0

# yamllint disable rule:line-length
---
resources:
  - https://raw.githubusercontent.com/rook/rook/release-1.18/deploy/examples/crds.yaml
  - https://raw.githubusercontent.com/rook/rook/release-1.18/deploy/examples/common.yaml
  - https://raw.githubusercontent.com/rook/rook/release-1.18/deploy/examples/operator.yaml

patches:
  - target:
      kind: ConfigMap
      name: rook-ceph-operator-config
      namespace: rook-ceph
    patch: |-
      - op: add
        path: /data/CSI_ENABLE_CSIADDONS
        value: 'true'
      - op: add
        path: /data/CSI_ENABLE_OMAP_GENERATOR
        value: 'true'
      # Rook now uses ceph-csi-operator to deploy CSI by default.
      # Ramen is not yet configured to use ceph-csi-operator,
      # so this flag is still required until that is done.
      - op: replace
        path: /data/ROOK_USE_CSI_OPERATOR
        value: 'false'
  # Disable to avoid random failures when restaring the enviroment.
  #   failed to call webhook:
  #   Post "https://rook-ceph-admission-controller.rook-ceph.svc:443/
  #   validate-ceph-rook-io-v1-cephblockpool?timeout=5s":
  #   x509: certificate signed by unknown authority
  - target:
      kind: Deployment
      name: rook-ceph-operator
    patch: |-
      apiVersion: apps/v1
      kind: Deployment
      metadata:
        name: not-used
      spec:
        template:
          spec:
            containers:
              - name: rook-ceph-operator
                env:
                  - name: ROOK_DISABLE_ADMISSION_CONTROLLER
                    value: 'true'
                  # Using quay.io/csiaddons/k8s-sidecar image
                  # with digest sha256:66a7257319284294181b7a3ba639d0706ea8b12783997d17056132021e9e13d7,
                  # which was the latest image available at the time of writing.
                  - name: ROOK_CSIADDONS_IMAGE
                    value: quay.io/csiaddons/k8s-sidecar@sha256:66a7257319284294181b7a3ba639d0706ea8b12783997d17056132021e9e13d7
